{% extends "base.html" %}
{% block content %}
{% set HIDDEN_TABLES = ['todos', 'users'] %}

<style>
  :root{
    --panel: rgba(255,255,255,0.92);
    --border: rgba(255,255,255,0.35);
    --text: #202122;
    --muted: #54595d;
    --shadow: 0 10px 30px rgba(0,0,0,0.25);
    --accent: #c62828;
  }

  /* FULL BACKGROUND IMAGE (replaces gray) */
  body{
    background-image:
      linear-gradient(rgba(10, 10, 12, 0.65), rgba(10, 10, 12, 0.65)),
      url("{{ url_for('static', filename='img/deadcells_bg.jpg') }}");
  background-image:
    linear-gradient(rgba(10, 10, 12, 0.65), rgba(10, 10, 12, 0.65)),
    url("{{ url_for('static', filename='deadcells_bg.jpg') }}");

    background-size: cover;
    background-position: center top;
    background-repeat: no-repeat;
    background-attachment: fixed;
  background-size: cover;
  background-position: center top;
  background-repeat: no-repeat;
  background-attachment: fixed;
  }


  /* MAIN WRAPPER */
  .wiki-wrap{
    max-width: 1280px;
    margin: 0 auto;
    padding: 18px 14px 30px;
  }

  /* CARDS */
  .wiki-topbar,
  .wiki-box,
  .wiki-main,
  .section{
    background: var(--panel);
    backdrop-filter: blur(6px);
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: var(--shadow);
  }

  .wiki-topbar{
    margin-bottom: 14px;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .wiki-logo{
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: linear-gradient(135deg, #c62828, #111);
  }

  .wiki-brand .title{
    font-weight: 800;
    font-size: 16px;
  }

  .wiki-brand .subtitle{
    font-size: 12px;
    color: var(--muted);
  }

  /* LAYOUT */
  .wiki-grid{
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 14px;
  }

  .wiki-side{
    position: sticky;
    top: 14px;
  }

  .wiki-box-h{
    padding: 10px 12px;
    background: rgba(255,255,255,0.6);
    border-bottom: 1px solid var(--border);
    font-weight: 800;
    font-size: 13px;
    text-transform: uppercase;
  }

  .wiki-box-b{
    padding: 10px;
  }

  /* TABLE LIST */
  .table-list{
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 70vh;
    overflow: auto;
  }

  .table-item{
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    background: #fff;
  }

  .table-item:hover{
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  .table-item code{
    color: #c62828;
    font-size: 12px;
  }

  .table-item.active{
    border-color: #c62828;
    background: #fff2f2;
  }

  .dot{
    width: 8px;
    height: 8px;
    border-radius: 99px;
    background: #cfd3da;
  }

  .table-item.active .dot{
    background: #c62828;
  }

  /* MAIN CONTENT */
  .wiki-main-head{
    padding: 16px 18px 10px;
    border-bottom: 1px solid var(--border);
  }

  .page-title{
    font-size: 34px;
    margin: 0;
  }

  .page-lead{
    margin-top: 6px;
    font-size: 13px;
    color: var(--muted);
  }

  .wiki-main-body{
    padding: 14px 18px 18px;
  }

  /* TABLE SECTIONS */
  .section{
    margin-top: 14px;
    overflow: hidden;
  }

  .section-h{
    display: flex;
    justify-content: space-between;
    padding: 10px 12px;
    background: rgba(255,255,255,0.6);
    border-bottom: 1px solid var(--border);
  }

  .section-h h3{
    margin: 0;
    font-size: 16px;
  }

  .meta{
    font-size: 12px;
    color: var(--muted);
  }

  .tablewrap{
    overflow: auto;
  }

  table.wikitable{
    width: 100%;
    border-collapse: collapse;
    min-width: 720px;
    font-size: 13px;
  }

  table.wikitable th,
  table.wikitable td{
    border-bottom: 1px solid var(--border);
    padding: 8px 10px;
    white-space: nowrap;
  }

  table.wikitable th{
    background: #eaecf0;
    text-align: left;
    font-size: 12px;
  }

  table.wikitable tbody tr:nth-child(even) td{
    background: #fcfcfd;
  }

  @media (max-width: 980px){
    .wiki-grid{ grid-template-columns: 1fr; }
    .wiki-side{ position: static; }
  }
</style>

<div class="wiki-wrap">

  <div class="wiki-topbar">
    <div class="wiki-logo"></div>
    <div class="wiki-brand">
      <div class="title">Deadcells fan wiki</div>
      <div class="subtitle">Database explorer</div>
    </div>
  </div>

  <div class="wiki-grid">

    <aside class="wiki-side">
      <div class="wiki-box">
        <div class="wiki-box-h">Navigation</div>
        <div class="wiki-box-b">
          <div class="table-list" id="tableList">
            {% for t in table_names %}
              {% if t|lower not in HIDDEN_TABLES %}
                <div class="table-item" data-table="{{ t }}">
                  <code>{{ t }}</code>
                  <span class="dot"></span>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </aside>

    <main class="wiki-main">
      <div class="wiki-main-head">
        <h1 class="page-title">Database Tables</h1>
        <div class="page-lead">
          Click a table name in the sidebar to toggle it on/off.
        </div>
      </div>

      <div class="wiki-main-body">
        <div id="results"></div>
      </div>
    </main>

  </div>
</div>

<script>
  const tableList = document.getElementById("tableList");
  const results = document.getElementById("results");
  const loadedTables = new Set();
  const DEFAULT_LIMIT = 50;

  function escapeText(s) {
    if (s === null || s === undefined) return "";
    return String(s);
  }

  function removeTableCard(tableName) {
    const el = results.querySelector(`[data-table-card="${tableName}"]`);
    if (el) el.remove();
  }

  function renderTableCard(tableName, payload) {
    const section = document.createElement("section");
    section.className = "section";
    section.setAttribute("data-table-card", tableName);

    const head = document.createElement("div");
    head.className = "section-h";

    const h3 = document.createElement("h3");
    h3.textContent = tableName;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${payload.count} rows`;

    head.appendChild(h3);
    head.appendChild(meta);
    section.appendChild(head);

    const wrap = document.createElement("div");
    wrap.className = "tablewrap";

    const table = document.createElement("table");
    table.className = "wikitable";

    const thead = document.createElement("thead");
    const thr = document.createElement("tr");

    payload.columns.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col;
      thr.appendChild(th);
    });

    thead.appendChild(thr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    payload.rows.forEach(r => {
      const tr = document.createElement("tr");
      payload.columns.forEach(col => {
        const td = document.createElement("td");
        td.textContent = escapeText(r[col]);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrap.appendChild(table);
    section.appendChild(wrap);

    return section;
  }

  async function loadTable(tableName) {
    const resp = await fetch("/dbexplorer/api/tables", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ tables: [tableName], limit: DEFAULT_LIMIT })
    });

    if (!resp.ok) return;

    const data = await resp.json();
    if (!data[tableName]) return;

    removeTableCard(tableName);
    results.appendChild(renderTableCard(tableName, data[tableName]));
  }

  tableList.addEventListener("click", async (e) => {
    const item = e.target.closest(".table-item[data-table]");
    if (!item) return;

    const tableName = item.getAttribute("data-table");

    if (loadedTables.has(tableName)) {
      loadedTables.delete(tableName);
      removeTableCard(tableName);
      item.classList.remove("active");
      return;
    }

    loadedTables.add(tableName);
    item.classList.add("active");
    await loadTable(tableName);
  });
</script>

{% endblock %}